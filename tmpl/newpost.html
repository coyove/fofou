<div style="margin: 4px 0">
    <div style="text-align: center">
<button onclick="$(this).hide();$('#newpost').show()" id="expand-newpost">{{if .TopicID}}回复主题{{else}}发布新主题{{end}}</button>
    </div>

<table cellspacing="0" id="newpost" uuid="{{.PostToken}}" style="margin: 0 auto">
    <tbody>
        {{if not .TopicID}}
        <tr>
            <th><label for="subject">标题:</label></th>
            <td>
                <input maxlength="256" id="subject" type="edit" placeholder="留空">
            </td>
        </tr>

        <tr>
            <th><label for="sage">sage:</label></th>
            <td>
                <input type="checkbox" id="sage" name="sage" style="width: 20px">
            </td>
        </tr>
        {{else}}
        <script> window.TOPIC_ID = {{.TopicID}} </script>
        {{end}}

        <tr>
            <th>正文:</th>
            <td>
                <textarea id="message" rows="10" wrap="virtual"></textarea>
            </td>
        </tr>

        {{if not .Forum.NoImageUpload}}
        <tr>
            <th>图片:</th>
            <td>
                <input type="file" id="select-image"/>
            </td>
        </tr>
        {{end}}

        {{if not .Forum.NoRecaptcha}}
        <tr>
            <th>验证:</th>
            <td>
                <div id="recaptcha">...</div>
            </td>
        </tr>
        {{end}}

        <tr>
            <td></td>
            <td>
                <button onclick='_submit(this)' id="submit-newpost">{{if .TopicID}}回复{{else}}新主题{{end}}</button>
                {{if .Forum.NoMoreNewUsers}}
                当前未持有cookie的匿名用户无法发言
                {{end}}
                <script>
                    var p = document.cookie.match(/'Posts':(\d+)/);
                    var n = document.cookie.match(/'N':(\d+)/);
if (p && n) {
    // tan((y - 0.5 - 0.01) * pi) = n - x
    var x = parseFloat(p[1]);
    var n = parseFloat(n[1]);
    var y = 1 - (Math.atan(n - x) / Math.PI + 0.5 + 0.01);
    $('#submit-newpost').append(" (" + y.toFixed(2) + ")").focus();
} else {
    $('#submit-newpost').append(" (0.00)").focus();
}

function _reply(longid, del) {
    $('#message').append(del ? "!!delete=" + longid + "\n请将该内容作为新主题提交以删除：" + longid : "\n>>" + longid).trigger('render');
    $('#expand-newpost').hide();
    $([document.documentElement, document.body]).animate({
        scrollTop: $('#newpost').show().offset().top
    }, 500);
}
                </script>
            </td> 
        </tr>
    </tbody>
</table>
<hr>
</div>

<script src="https://www.recaptcha.net/recaptcha/api.js?onload=onloadRecaptcha&render=explicit&hl=zh_CN" async defer></script>
<script>
    function onloadRecaptcha() {
        function callback() {
            if ($(this).prop('recaptcha')) return;
            try {
                grecaptcha.render("recaptcha", {"sitekey": "{{.Forum.RecaptchaToken}}", "theme": "light"});
            } catch(e) {
            } finally {
                $(this).prop('recaptcha', true);
            }
        }
        $("#message").on('focus', callback).bind("render", callback);
        $("#select-image").on('change', callback);
    }

$('#newpost').hide();
</script>


