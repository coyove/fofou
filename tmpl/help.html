{{template "header.html" .}}

<style>
#ranking {
    width: 100%;
    max-width: 360px;
        margin: 4px 0;
}
</style>

<img id="ranking" />

<ol>
    <li>用户发言前需要先完成机器人验证。该验证随着发言次数的增加而变得越没有必要——该“必要性”显示为按钮旁的数字，例如0.91表示如果不完成验证直接提交，那么有91%的可能发布成功。如果发布失败，服务端将提示您完成验证后再发。
</ol>

<script>
    function drawCurve(n, p) {
        if (n < 5 || n > 20) n = 20;

        var canvas = document.createElement("canvas"), root = document.createElement("canvas");
        canvas.width = 360;
        canvas.height = 120;
        root.width = canvas.width - 10;
        root.height = canvas.height - 30;

        var ctx = root.getContext('2d');
        var len = n * 2;
        var height = root.height, width = root.width - 36;
        var delta = 4;
        var h0 = height - delta * 2;
        var points = [];
        var calcY_ = function(x) { return 1 - (Math.atan(n - x) / Math.PI + 0.5 + 0.01); }
        var calcY = function(x) { return h0 - calcY_(x) * h0 + delta; }
        var tick = Math.ceil(len / 10);

        ctx.font = '12px "Lucida Console", Monaco, monospace';
        for (var x = 0; x < len; x += 0.125) {
            var y0 = calcY(x);
            var x0 = x * width / len;

            points.push({x: x0, y: y0});

            if (x % 1 == 0) {
                ctx.beginPath();
                ctx.strokeStyle = x % tick == 0 ? '#cccccc' : '#eeeeee';
                ctx.moveTo(x0 + 1, 0);
                ctx.lineTo(x0 + 1, height);
                ctx.stroke();
            }
        }
        for (var x = 0; x < len; x += tick) {
            var x0 = x * width / len;
            ctx.fillText(x, x0 + 2, height - 3);
        }

        if (p >= len) p = len - 1;

        ctx.strokeStyle = 'red';
        ctx.beginPath();
        x0 = p * width / len + 1, y0 = calcY(p);
        ctx.moveTo(x0, 0);
        ctx.lineTo(x0, height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, y0);
        ctx.setLineDash([3, 3]);
        ctx.lineTo(width, y0);
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.beginPath();
        ctx.arc(x0, y0, 2, 0, 2 * Math.PI);
        ctx.fillStyle = "#ff5e5e";
        ctx.fill();

        ctx.strokeStyle = 'black';
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for(var i = 1; i < points.length-1; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.lineTo(width - 1, points[i].y);
        ctx.lineTo(width - 1, height);
        ctx.lineTo(0, height);
        ctx.closePath();
        ctx.fillStyle = "rgba(0, 188, 212, 0.1)";
        ctx.fill();
        ctx.stroke();

        ctx.textBaseline = "middle";
        ctx.textAlign="center"; 
        ctx.fillStyle="red";
        ctx.fillText(calcY_(p).toFixed(2), width + 18, y0);

        ctx.strokeStyle = 'black';
        ctx.strokeRect(1, 1, width - 2, height - 2);

        ctx = canvas.getContext('2d');
        ctx.font = '12px "Lucida Console", Monaco, monospace';
        ctx.fillStyle="white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(root, 5, 25);
        ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);
        ctx.fillStyle="black";
        ctx.textAlign="center"; 
        ctx.textBaseline = "middle";
        ctx.fillText("Pascal " + new Date().toLocaleDateString(), canvas.width / 2, 12);

        return canvas.toDataURL();
    }

var p = document.cookie.match(/'Posts':(\d+)/);
var n = document.cookie.match(/'N':(\d+)/);
if (p && n) {
    var p = parseFloat(p[1]);
    var n = parseFloat(n[1]);
    $('#ranking').attr('src', drawCurve(n, p));
}
</script>
